<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TrueStyle - Checkout</title>
  <link rel="icon" href="/assets/icon.png"/>
  <link rel="stylesheet" href="/style/index.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-white text-slate-900">
  <!-- Navbar -->
  <div data-include="/src/Components/navbar.html"></div>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <section class="grid lg:grid-cols-[1fr_.6fr] gap-8">
      <!-- LEFT: DETAILS -->
      <div class="space-y-6">
        <!-- Address -->
        <section class="rounded-3xl ring-1 ring-slate-200 p-4 shadow-sm">
          <h3 class="font-semibold mb-3">Shipping Address</h3>
          <select id="addressSel" class="w-full rounded-2xl bg-slate-50 shadow-inner px-3 py-2 outline-none"></select>
          <p class="text-xs text-slate-500 mt-2">
            Manage addresses in
            <a href="/src/Features/Addresses/addresses.html" class="underline">Profile → Addresses</a>.
          </p>
          <p id="errAddress" class="hidden mt-2 text-sm text-rose-600"></p>
        </section>

        <!-- Coupon -->
        <section class="rounded-3xl ring-1 ring-slate-200 p-4 shadow-sm">
          <h3 class="font-semibold mb-3">Apply Coupon</h3>
          <div class="flex gap-2">
            <input id="couponInput" placeholder="WELCOME10 / SAVE200"
              class="flex-1 rounded-2xl bg-slate-50 shadow-inner px-3 py-2 outline-none"/>
            <button id="applyCoupon"
              class="px-4 py-2 rounded-lg cursor-pointer ring-1 ring-slate-200 text-md hover:bg-slate-50">
              Apply
            </button>
          </div>
          <div id="couponMsg" class="text-sm mt-2 text-slate-600"></div>
        </section>

        <!-- Payment -->
        <section class="rounded-3xl ring-1 ring-slate-200 p-4 shadow-sm">
          <h3 class="font-semibold mb-3">Payment Method</h3>

          <div class="grid gap-2 text-sm">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="pay" value="upi" checked>
              <span>UPI </span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="pay" value="card">
              <span>Card</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="pay" value="cod">
              <span>Cash on Delivery</span>
            </label>
          </div>

          <!-- UPI form -->
          <form id="formUPI" class="mt-4 grid gap-3">
            <div>
              <label class="text-sm">UPI ID <span class="text-red-600">*</span> </label>
              <input id="upiId" placeholder="yourname@bank" autocomplete="off"
                class="mt-1 w-full rounded-2xl bg-slate-50 shadow-inner px-3 py-2 outline-none"/>
              <p id="errUpiId" class="hidden mt-1 text-sm text-rose-600"></p>
            </div>
            <div>
              <label class="text-sm">Account Holder Name <span class="text-red-600">*</span> </label>
              <input id="upiName" placeholder="Full name (as per bank)" autocomplete="off"
                class="mt-1 w-full rounded-2xl bg-slate-50 shadow-inner px-3 py-2 outline-none"/>
              <p id="errUpiName" class="hidden mt-1 text-sm text-rose-600"></p>
            </div>
          </form>

          <!-- Card form -->
          <form id="formCARD" class="mt-4 grid gap-3 hidden">
            <div>
              <label class="text-sm">Name on Card <span class="text-red-500">*</span> </label>
              <input id="cardName" placeholder="Full name"
                class="mt-1 w-full rounded-2xl bg-slate-50 shadow-inner px-3 py-2 outline-none"/>
              <p id="errCardName" class="hidden mt-1 text-sm text-rose-600"></p>
            </div>
            <div>
              <label class="text-sm">Card Number <span class="text-red-600">*</span></label>
              <input id="cardNumber" inputmode="numeric" placeholder="#### #### #### ####"
                class="mt-1 w-full rounded-2xl bg-slate-50 shadow-inner px-3 py-2 outline-none"/>
              <p id="errCardNumber" class="hidden mt-1 text-sm text-rose-600"></p>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm">Expiry (MM/YY) <span class="text-red-600">*</span></label>
                <input id="cardExp" inputmode="numeric" placeholder="MM/YY"
                  class="mt-1 w-full rounded-2xl bg-slate-50 shadow-inner px-3 py-2 outline-none"/>
                <p id="errCardExp" class="hidden mt-1 text-sm text-rose-600"></p>
              </div>
              <div>
                <label class="text-sm">CVV <span class="text-red-600">*</span></label>
                <input id="cardCvv" inputmode="numeric" placeholder="3 or 4 digits"
                  class="mt-1 w-full rounded-2xl bg-slate-50 shadow-inner px-3 py-2 outline-none"/>
                <p id="errCardCvv" class="hidden mt-1 text-sm text-rose-600"></p>
              </div>
            </div>
          </form>

          <!-- COD note -->
          <div id="codNote" class="hidden mt-4 text-sm text-slate-600">
            Cash payment to be collected at delivery.
          </div>
        </section>
      </div>

      <!-- RIGHT: SUMMARY -->
      <aside class="rounded-3xl ring-1 ring-slate-200 p-4 shadow-sm h-fit">
        <h3 class="font-semibold mb-3">Order Summary</h3>
        <div class="flex justify-between text-sm py-1"><span>Items</span><span id="sumItems">₹0</span></div>
        <div class="flex justify-between text-sm py-1"><span>Discount</span><span id="sumDisc">₹0</span></div>
        <hr class="my-2">
        <div class="flex justify-between font-semibold text-base py-1"><span>To Pay</span><span id="sumTotal">₹0</span></div>
        <button id="payNow" class="mt-3 w-full px-4 py-2 rounded-lg cursor-pointer bg-slate-900 text-white text-md hover:opacity-95">
          Pay Now
        </button>
        <p class="mt-2 text-xs text-slate-500">You can review your order on the next screen.</p>
      </aside>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t mt-8">
    <div class="w-full p-6 md:p-10">
      <div class="grid gap-8 md:grid-cols-3">
        <div>
          <h3 class="font-semibold text-xl mb-4">Download the App</h3>
          <div class="flex items-center gap-3">
            <a href="#" class="inline-flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 px-4 py-2 shadow-sm hover:bg-slate-50">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"/></svg>
              <span class="text-sm font-medium">Google Play</span>
            </a>
            <a href="#" class="inline-flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 px-4 py-2 shadow-sm hover:bg-slate-50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M16.365 1.43a5.6 5.6 0 01-1.382 3.91 4.9 4.9 0 01-3.515 1.64 5.45 5.45 0 011.372-3.97A5.15 5.15 0 0116.365 1.43zM20.5 17.48c-.435 1.01-.658 1.48-1.23 2.39-.8 1.27-1.93 2.85-3.34 2.86-1.25.01-1.58-.84-3.29-.84-1.72 0-2.1.82-3.34.85-1.39.03-2.46-1.37-3.26-2.64-1.78-2.8-3.14-7.92-1.31-11.41.9-1.7 2.5-2.77 4.33-2.8 1.31-.03 2.55.9 3.29.9.73 0 2.26-1.12 3.81-.95.65.03 2.48.26 3.66 1.97-3.22 1.76-2.7 6.41.65 7.67z"/></svg>
              <span class="text-sm font-medium">App Store</span>
            </a>
          </div>
        </div>

        <div>
          <h3 class="font-semibold text-xl mb-4">Shop</h3>
          <ul class="space-y-2 text-sm text-slate-600">
            <li><a href="#" class="hover:text-[var(--color-primary)]">Women’s</a></li>
            <li><a href="#" class="hover:text-[var(--color-primary)]">Men’s</a></li>
            <li><a href="#" class="hover:text-[var(--color-primary)]">Kids</a></li>
          </ul>
        </div>

        <div>
          <h3 class="font-semibold text-xl mb-4">About</h3>
          <ul class="space-y-2 text-sm text-slate-600">
            <li><a href="#" class="hover:text-[var(--color-primary)]">About Us</a></li>
            <li><a href="#" class="hover:text-[var(--color-primary)]">Give Feedback</a></li>
            <li><a href="#" class="hover:text-[var(--color-primary)]">Store Locator</a></li>
            <li><a href="mailto:truestyle@example.com" class="hover:text-[var(--color-primary)]">Support: truestyle@example.com | +91 1234567890</a></li>
          </ul>
        </div>
      </div>

      <div class="mt-8 grid gap-4 md:grid-cols-4 text-xs text-slate-500">
        <a href="#policies" class="hover:text-[var(--color-primary)]">Terms &amp; Conditions</a>
        <a href="#policies" class="hover:text-[var(--color-primary)]">Return Policy</a>
        <a href="#policies" class="hover:text-[var(--color-primary)]">Exchange Policy</a>
        <a href="#policies" class="hover:text-[var(--color-primary)]">Privacy Policy</a>
      </div>

      <p class="mt-6 text-sm text-slate-500 text-center">&#169; 2025 TrueStyle. All Rights Reserved.</p>
    </div>
  </footer>

  <!-- Data / Icons -->
  <script src="/Model/appdb.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>

  <script>
    // ---------- Shared helpers ----------
    const $  = (q, root=document)=>root.querySelector(q);
    const $$ = (q, root=document)=>Array.from(root.querySelectorAll(q));
    const fmtINR = n => '₹' + (n||0).toLocaleString('en-IN');

    function currentUserId(){
      try{
        if (window.TSAuth?.user?.id) return TSAuth.user.id;
        const u=(AppDB.select('User')||[])[0];
        return u?.id||2001;
      }catch{ return 2001; }
    }

    async function injectPartials(){
      await Promise.all($$('[data-include]').map(async n=>{
        const url=n.getAttribute('data-include');
        const html=await fetch(url).then(r=>r.text());
        n.outerHTML=html;
      }));
    }

    function refreshCartBadge(){
      const uid=currentUserId();
      const items=AppDBHelpers.getCart(uid)||[];
      const total=items.reduce((a,i)=>a+(i.Quantity||1),0);
      const b=$("#cartBadge"); if(!b) return;
      if(total>0){ b.textContent=total; b.classList.remove('hidden'); }
      else b.classList.add('hidden');
    }

    function initNavInteractions(){
      lucide.createIcons();
      const btn=$("#profileBtn"), menu=$("#profileMenu");
      btn?.addEventListener("click", ()=>menu?.classList.toggle("hidden"));
      document.addEventListener("click",(e)=>{
        if(!menu?.contains(e.target) && !btn?.contains(e.target)) menu?.classList.add("hidden");
      });

      $("#logOut")?.addEventListener("click", ()=>{
        localStorage.removeItem("ts_is_logged_in");
        localStorage.removeItem("ts_role");
        localStorage.removeItem("ts_user_id");
        location.replace("/index.html");
      });

      // Navbar search → home search
      $("#navSearchForm")?.addEventListener("submit",(e)=>{
        e.preventDefault();
        const v=$("#navSearch").value.trim();
        if(!v) return;
        location.href=`/user/index.html?q=${encodeURIComponent(v)}`;
      });

      refreshCartBadge();
    }
  </script>

  <script>
    // ---------- Page State ----------
    let discount = 0;
    const touched = new Set(); // for lazy validation

    document.addEventListener('DOMContentLoaded', setup);

    async function setup(){
      await injectPartials();
      initNavInteractions();

      const uid=currentUserId();

      // addresses
      const addresses=(AppDB.select('User_Address')||[]).filter(a=>a.User_Id===uid);
      const sel=$("#addressSel");
      sel.innerHTML = addresses.length
        ? addresses.map(a=>`<option value="${a.id}">${a.Address}, ${a.City}, ${a.State} ${a.Postal_Code}</option>`).join('')
        : `<option value="">No address — add one in Profile</option>`;
      sel.addEventListener('change', ()=> clearErr('errAddress'));

      recalc();

      // coupon
      $("#applyCoupon").onclick = ()=>{
        const code=($("#couponInput").value||'').trim();
        const cart=AppDBHelpers.getCart(uid)||[];
        const subtotal = cart.reduce((a,ci)=>a+(ci.product?.price||0)*(ci.Quantity||1),0);

        const c=(AppDB.select('Coupon')||[]).find(x=> x.Code?.toLowerCase()===code.toLowerCase() && x.Status==='active');
        if(!code){ discount=0; setCouponMsg('',''); return recalc(); }
        if(!c){ discount=0; setCouponMsg('Invalid code','text-rose-600'); return recalc(); }
        discount = c.Type==='percent' ? Math.round(subtotal*(c.Value/100)) : Number(c.Value||0);
        setCouponMsg(`Applied ${c.Code}`,'text-emerald-700');
        recalc();
      };

      // payment radio switch
      $$('input[name="pay"]').forEach(r=>{
        r.addEventListener('change', onPayChange);
      });
      onPayChange(); // initialize

      // blur/change to mark fields touched
      ['upiId','upiName','cardName','cardNumber','cardExp','cardCvv'].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('blur', ()=>{ touched.add(id); validateVisiblePayment(); });
        el.addEventListener('input', ()=>{ if(touched.has(id)) validateVisiblePayment(); });
      });

      // pay
      $("#payNow").addEventListener('click', onPayNow);
    }

    function setCouponMsg(msg, cls){
      const el=$("#couponMsg");
      el.textContent = msg;
      el.className = "text-sm mt-2 "+(cls||"text-slate-600");
    }

    function recalc(){
      const uid=currentUserId();
      const cart=AppDBHelpers.getCart(uid)||[];
      const subtotal = cart.reduce((a,ci)=>a+(ci.product?.price||0)*(ci.Quantity||1),0);
      const total = Math.max(0, subtotal - discount);
      $("#sumItems").textContent = fmtINR(subtotal);
      $("#sumDisc").textContent  = '₹'+(discount||0);
      $("#sumTotal").textContent = fmtINR(total);
    }

    // ------- Payment mode toggling -------
    function onPayChange(){
      const mode = (document.querySelector('input[name="pay"]:checked')?.value)||'upi';
      const upi  = $("#formUPI");
      const card = $("#formCARD");
      const cod  = $("#codNote");
      upi.classList.toggle('hidden', mode!=='upi');
      card.classList.toggle('hidden', mode!=='card');
      cod.classList.toggle('hidden',  mode!=='cod');
      // clear previous messages
      clearPaymentErrors();
    }

    // ------- Validation helpers -------
    function showErr(id, msg){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = msg||'';
      el.classList.toggle('hidden', !msg);
    }
    function clearErr(id){ showErr(id, ''); }
    function clearPaymentErrors(){
      ['errUpiId','errUpiName','errCardName','errCardNumber','errCardExp','errCardCvv'].forEach(clearErr);
    }

    function luhnCheck(num){
      // digits only
      const s = (num||'').replace(/\s+/g,'').replace(/-/g,'');
      if(!/^\d{12,19}$/.test(s)) return false;
      let sum=0, flip=false;
      for(let i=s.length-1;i>=0;i--){
        let d = parseInt(s[i],10);
        if(flip){ d*=2; if(d>9) d-=9; }
        sum+=d; flip=!flip;
      }
      return sum%10===0;
    }

    function validateUPI(){
      const id = $("#upiId").value.trim();
      const name = $("#upiName").value.trim();
      let ok = true;

      if(!id){
        if(touched.has('upiId')) showErr('errUpiId','UPI ID is required'); ok=false;
      }else if(!/^[a-z0-9.\-_]{2,256}@[a-z]{2,64}$/i.test(id)){
        if(touched.has('upiId')) showErr('errUpiId','Enter a valid UPI ID (e.g., name@bank)'); ok=false;
      }else clearErr('errUpiId');

      if(!name){
        if(touched.has('upiName')) showErr('errUpiName','Name is required'); ok=false;
      }else clearErr('errUpiName');

      return ok;
    }

    function validateCARD(){
      const nm = $("#cardName").value.trim();
      const num= $("#cardNumber").value.replace(/\s+/g,'').replace(/-/g,'');
      const exp= $("#cardExp").value.trim();
      const cvv= $("#cardCvv").value.trim();
      let ok = true;

      if(!nm){ if(touched.has('cardName')) showErr('errCardName','Name is required'); ok=false; } else clearErr('errCardName');

      if(!num){
        if(touched.has('cardNumber')) showErr('errCardNumber','Card number is required'); ok=false;
      }else if(!luhnCheck(num)){
        if(touched.has('cardNumber')) showErr('errCardNumber','Enter a valid card number'); ok=false;
      }else clearErr('errCardNumber');

      if(!exp){
        if(touched.has('cardExp')) showErr('errCardExp','Expiry is required'); ok=false;
      }else{
        const m = exp.match(/^\s*(0[1-9]|1[0-2])\s*\/\s*(\d{2})\s*$/);
        if(!m){ if(touched.has('cardExp')) showErr('errCardExp','Use MM/YY'); ok=false; }
        else{
          const mm=parseInt(m[1],10), yy=parseInt(m[2],10);
          // expiry check: end of month >= now
          const now=new Date();
          const y2000 = 2000+yy;
          const expDate = new Date(y2000, mm, 0); // last day of month
          if(expDate < new Date(now.getFullYear(), now.getMonth(), 1)){
            if(touched.has('cardExp')) showErr('errCardExp','Card expired'); ok=false;
          } else clearErr('errCardExp');
        }
      }

      if(!cvv){
        if(touched.has('cardCvv')) showErr('errCardCvv','CVV is required'); ok=false;
      }else if(!/^\d{3,4}$/.test(cvv)){
        if(touched.has('cardCvv')) showErr('errCardCvv','Enter 3 or 4 digits'); ok=false;
      }else clearErr('errCardCvv');

      return ok;
    }

    function validateVisiblePayment(){
      const mode = (document.querySelector('input[name="pay"]:checked')?.value)||'upi';
      if(mode==='upi') return validateUPI();
      if(mode==='card') return validateCARD();
      return true; // cod
    }

    // ------- Pay Now -------
    function onPayNow(){
      const sel = $("#addressSel");
      const addressId = Number(sel.value||0);
      if(!addressId){
        showErr('errAddress','Please add/select an address');
        sel.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }else{
        clearErr('errAddress');
      }

      // mark visible fields as touched to surface errors
      const mode = (document.querySelector('input[name="pay"]:checked')?.value)||'upi';
      if(mode==='upi'){ touched.add('upiId'); touched.add('upiName'); }
      else if(mode==='card'){ touched.add('cardName'); touched.add('cardNumber'); touched.add('cardExp'); touched.add('cardCvv'); }
      const ok = validateVisiblePayment();
      if(!ok) return;

      // place order
      const uid=currentUserId();
      const code = ($("#couponInput").value||'').trim();
      const order = AppDBHelpers.placeOrder({ userId: uid, addressId, couponCode: code||null });
      if(!order){ alert('Your bag is empty'); return; }
      AppDB.update('Order', order.id, { Status: 2 }); // Confirmed 
      refreshCartBadge();
      location.href = '/src/Features/Orders/view-orders.html';
    }
  </script>
</body>
</html>