<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TrueStyle - Order Details</title>
    <link rel="icon" href="/assets/icon.png" />
    <link rel="stylesheet" href="/style/index.css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>
  <body class="bg-white text-slate-900">
    <!-- Navbar -->
    <div data-include="/src/Components/navbar.html"></div>

    <main class="max-w-5xl mx-auto px-4 py-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-xl font-semibold">Order details</h1>
        <div class="flex gap-2">
          <a
            href="/src/Features/Orders/view-orders.html"
            class="px-4 py-2 rounded-lg cursor-pointer ring-1 ring-slate-200 text-md hover:bg-slate-50"
            >Back to orders</a
          >
          <button
            id="dlInvoice"
            class="px-4 py-2 rounded-lg cursor-pointer bg-blue-600 text-md text-white hover:bg-blue-700"
          >
            Download invoice
          </button>
        </div>
      </div>

      <!-- Summary -->
      <section
        id="summaryCard"
        class="rounded-3xl ring-1 ring-slate-200 p-4 bg-white shadow-sm"
      ></section>

      <!-- Items -->
      <section
        class="mt-6 rounded-3xl ring-1 ring-slate-200 p-4 bg-white shadow-sm"
      >
        <h3 class="font-semibold mb-3">Items</h3>
        <ul id="itemsList" class="grid gap-3"></ul>
      </section>

      <!-- Flow -->
      <section
        class="mt-6 rounded-3xl ring-1 ring-slate-200 p-4 bg-white shadow-sm"
      >
        <h3 class="font-semibold mb-4">Order progress</h3>
        <div id="flowSteps" class="relative">
          <!-- steps injected -->
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-8">
      <div class="w-full p-6 md:p-10">
        <div class="grid gap-8 md:grid-cols-3">
          <div>
            <h3 class="font-semibold text-xl mb-4">Download the App</h3>
            <div class="flex items-center gap-3">
              <a
                href="#"
                class="inline-flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 px-4 py-2 shadow-sm hover:bg-slate-50"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M5 5a2 2 0 0 1 3-2l12 7a2 2 0 0 1 0 3l-12 7a2 2 0 0 1-3-2z"
                  />
                </svg>
                <span class="text-sm font-medium">Google Play</span>
              </a>
              <a
                href="#"
                class="inline-flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 px-4 py-2 shadow-sm hover:bg-slate-50"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M16.365 1.43a5.6 5.6 0 0 1-1.382 3.91 4.9 4.9 0 0 1-3.515 1.64 5.45 5.45 0 0 1 1.372-3.97A5.15 5.15 0 0 1 16.365 1.43zM20.5 17.48c-.435 1.01-.658 1.48-1.23 2.39-.8 1.27-1.93 2.85-3.34 2.86-1.25.01-1.58-.84-3.29-.84-1.72 0-2.1.82-3.34.85-1.39.03-2.46-1.37-3.26-2.64-1.78-2.8-3.14-7.92-1.31-11.41.9-1.7 2.5-2.77 4.33-2.8 1.31-.03 2.55.9 3.29.9.73 0 2.26-1.12 3.81-.95.65.03 2.48.26 3.66 1.97-3.22 1.76-2.7 6.41.65 7.67z"
                  />
                </svg>
                <span class="text-sm font-medium">App Store</span>
              </a>
            </div>
          </div>
          <div>
            <h3 class="font-semibold text-xl mb-4">Shop</h3>
            <ul class="space-y-2 text-sm text-slate-600">
              <li>
                <a href="#" class="hover:text-[var(--color-primary)]"
                  >Women’s</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-[var(--color-primary)]">Men’s</a>
              </li>
              <li>
                <a href="#" class="hover:text-[var(--color-primary)]">Kids</a>
              </li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold text-xl mb-4">About</h3>
            <ul class="space-y-2 text-sm text-slate-600">
              <li>
                <a href="#" class="hover:text-[var(--color-primary)]"
                  >About Us</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-[var(--color-primary)]"
                  >Give Feedback</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-[var(--color-primary)]"
                  >Store Locator</a
                >
              </li>
              <li>
                <a
                  href="mailto:truestyle@example.com"
                  class="hover:text-[var(--color-primary)]"
                  >Support: truestyle@example.com | +91 1234567890</a
                >
              </li>
            </ul>
          </div>
        </div>
        <div class="mt-8 grid gap-4 md:grid-cols-4 text-xs text-slate-500">
          <a href="#policies" class="hover:text-[var(--color-primary)]"
            >Terms &amp; Conditions</a
          >
          <a href="#policies" class="hover:text-[var(--color-primary)]"
            >Return Policy</a
          >
          <a href="#policies" class="hover:text-[var(--color-primary)]"
            >Exchange Policy</a
          >
          <a href="#policies" class="hover:text-[var(--color-primary)]"
            >Privacy Policy</a
          >
        </div>
        <p class="mt-6 text-sm text-slate-500 text-center">
          &#169; 2025 TrueStyle. All Rights Reserved.
        </p>
      </div>
    </footer>

    <!-- Data / Icons -->
    <script src="/Model/appdb.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>

    <script>
      
      const $ = (q, root = document) => root.querySelector(q);
      const $$ = (q, root = document) => Array.from(root.querySelectorAll(q));
      const fmtINR = (n) => "₹" + (n || 0).toLocaleString("en-IN");
      function currentUserId() {
        try {
          if (window.TSAuth?.user?.id) return TSAuth.user.id;
          const u = (AppDB.select("User") || [])[0];
          return u?.id || 2001;
        } catch {
          return 2001;
        }
      }
      async function injectPartials() {
        await Promise.all(
          $$("[data-include]").map(async (n) => {
            const url = n.getAttribute("data-include");
            const html = await fetch(url).then((r) => r.text());
            n.outerHTML = html;
          })
        );
      }
      function statusChipClass(id) {
        switch (id) {
          case 1:
            return "bg-slate-50 text-slate-700 ring-1 ring-slate-200";
          case 2:
            return "bg-blue-50 text-blue-700 ring-1 ring-blue-200";
          case 3:
            return "bg-indigo-50 text-indigo-700 ring-1 ring-indigo-200";
          case 4:
            return "bg-sky-50 text-sky-700 ring-1 ring-sky-200";
          case 5:
            return "bg-amber-50 text-amber-700 ring-1 ring-amber-200";
          case 6:
            return "bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200";
          case 7:
            return "bg-rose-50 text-rose-700 ring-1 ring-rose-200";
          case 8:
            return "bg-slate-50 text-slate-700 ring-1 ring-slate-200";
          default:
            return "bg-slate-50 text-slate-700 ring-1 ring-slate-200";
        }
      }

      

      document.addEventListener("DOMContentLoaded", async () => {
        await injectPartials();
        render();
      });

      function render() {
        const url = new URL(location.href);
        const id = Number(url.searchParams.get("id") || 0);
        const o = AppDB.get("Order", id);
        if (!o) {
          document.getElementById("summaryCard").innerHTML =
            '<div class="text-sm text-rose-600">Order not found.</div>';
          return;
        }

        const items = (AppDB.select("Order_Item") || [])
          .filter((oi) => oi.Linked_Order_Id === o.id)
          .map((oi) => ({
            ...oi,
            product: AppDB.get("Product", oi.Linked_Product_Id),
          }));
        const addr = AppDB.get("User_Address", o.Shipping_Address_Id);

        // Summary
        const summary = `
        <div class="flex flex-wrap items-center justify-between gap-2">
          <div class="flex items-center gap-3">
            <div class="text-sm text-slate-500">Order</div>
            <div class="font-semibold">#${o.id}</div>
            <span class="text-xs px-2 py-1 rounded-full ${statusChipClass(
              o.Status
            )}">${
          AppDB._state.Order_Status.find((s) => s.id === o.Status)
            ?.Display_Text || "#" + o.Status
        }</span>
          </div>
          <div class="text-sm text-slate-600">${new Date(
            o.Creation_Date
          ).toLocaleString()}</div>
        </div>
        <div class="mt-3 grid md:grid-cols-3 gap-3 text-sm">
          <div><span class="text-slate-500">Ship to:</span> ${
            addr
              ? `${addr.Address}, ${addr.City}, ${addr.State} ${addr.Postal_Code}`
              : "—"
          }</div>
          <div><span class="text-slate-500">Payment:</span> <span class="font-medium">Paid</span></div>
          <div class="md:text-right"><span class="text-slate-500">Total:</span> <span class="font-semibold">${fmtINR(
            o.Total || 0
          )}</span></div>
        </div>`;
        document.getElementById("summaryCard").innerHTML = summary;

        // Items
        document.getElementById("itemsList").innerHTML = items
          .map(
            (it) => `
        <li class="flex items-center gap-3">
          <img src="${
            it.product?.Thumbnail
          }" class="h-20 w-20 rounded-xl object-fit" alt="">
          <div class="flex-1">
            <div class="text-sm">${it.product?.Name}</div>
            <div class="text-xs text-slate-600">Qty ${it.Quantity}</div>
          </div>
          <div class="font-semibold">${fmtINR(
            (it.product?.price || 0) * (it.Quantity || 1)
          )}</div>
        </li>
      `
          )
          .join("");

        // Progress flow
        renderFlow(o.Status);

        // Download invoice
        document.getElementById("dlInvoice").addEventListener("click", () => {
          const full = {
            ...o,
            items,
            address: addr,
            statusText:
              AppDB._state.Order_Status.find((s) => s.id === o.Status)
                ?.Display_Text || "",
          };
          downloadInvoice(full);
        });
      }

      function flowMaster() {
        // From your AppDB (1..8)
        return [
          { id: 1, label: "Placed", icon: "ShoppingCart" },
          { id: 2, label: "Confirmed", icon: "BadgeCheck" },
          { id: 3, label: "Packed", icon: "Package" },
          { id: 4, label: "Shipped", icon: "Truck" },
          { id: 5, label: "Out for delivery", icon: "Bike" },
          { id: 6, label: "Delivered", icon: "CheckCircle" },
          { id: 7, label: "Cancelled", icon: "XCircle" },
          { id: 8, label: "Returned", icon: "Undo2" },
        ];
      }
      // no-icon master
      function flowMaster() {
        return [
          { id: 1, label: "Placed" },
          { id: 2, label: "Confirmed" },
          { id: 3, label: "Packed" },
          { id: 4, label: "Shipped" },
          { id: 5, label: "Out for delivery" },
          { id: 6, label: "Delivered" },
          { id: 7, label: "Cancelled" },
          { id: 8, label: "Returned" },
        ];
      }

      // perfectly synced progress
      function renderFlow(currentId) {
        const stepsAll = flowMaster();

        // terminal statuses stop the flow there; otherwise show up to Delivered
        const isTerminal = currentId === 7 || currentId === 8;
        const seq = isTerminal
          ? stepsAll.slice(0, stepsAll.findIndex((s) => s.id === currentId) + 1)
          : stepsAll.slice(0, 6); // 1..6

        const idx = Math.max(
          0,
          seq.findIndex((s) => s.id === currentId)
        );
        const n = seq.length;
        const pct = n > 1 ? ((idx / (n - 1)) * 100).toFixed(4) : 0;

        // dot size + colors
        const DOT_PX = 14; // tweak if you want bigger dots
        const fillColor =
          currentId === 7 || currentId === 8 ? "#e11d48" : "#0f172a"; // rose for cancelled/returned, dark for normal

        document.getElementById("flowSteps").innerHTML = `
      <div class="relative" style="--dot:${DOT_PX}px;">
        <!-- Track from center of first dot to center of last dot -->
        <div class="absolute h-[2px] bg-slate-200"
             style="left: calc(var(--dot)/2); right: calc(var(--dot)/2); top: calc(var(--dot)/2);"></div>

        <!-- Filled part ends at center of the active dot -->
        <div class="absolute h-[2px]"
             style="left: calc(var(--dot)/2); width: ${pct}%; top: calc(var(--dot)/2); background: ${fillColor};"></div>

        <!-- Dots + labels, evenly spaced -->
        <div class="relative flex justify-between">
          ${seq
            .map((s, i) => {
              const done = i <= idx;
              return `
              <div class="shrink-0 grid place-items-center min-w-0">
                <span class="rounded-full"
                      style="width:var(--dot);height:var(--dot);${
                        done
                          ? "background:" + fillColor + ";"
                          : "background:#fff; box-shadow: inset 0 0 0 1px #e2e8f0;"
                      }"></span>
                <span class="mt-2 text-[11px] ${
                  done ? "text-slate-900" : "text-slate-500"
                } truncate max-w-[90px]">
                  ${s.label}
                </span>
              </div>`;
            })
            .join("")}
        </div>
      </div>`;
      }

      // Reuse invoice from list page style
      function downloadInvoice(order) {
        const addr =
          AppDB.get("User_Address", order.Shipping_Address_Id) || order.address;
        const rows = (order.items || [])
          .map((it) => {
            const price = it.product?.price || 0;
            return `<tr><td>${
              it.product?.Name
            }</td><td style="text-align:center">${
              it.Quantity
            }</td><td style="text-align:right">${price.toLocaleString(
              "en-IN"
            )}</td><td style="text-align:right">${(
              price * (it.Quantity || 1)
            ).toLocaleString("en-IN")}</td></tr>`;
          })
          .join("");
        const html = `
<!doctype html><meta charset="utf-8">
<title>Invoice #${order.id} - TrueStyle</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:#0f172a;padding:24px}
  h1{font-size:18px;margin:0 0 4px}
  .sub{color:#475569}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #e2e8f0;padding:8px;font-size:14px}
  th{background:#f8fafc;text-align:left}
  .tot{font-weight:600}
</style>
<h1>TrueStyle Invoice</h1>
<div class="sub">Order #${order.id} • ${new Date(
          order.Creation_Date
        ).toLocaleString()}</div>
<hr style="border:none;border-top:1px solid #e2e8f0;margin:12px 0">
<div><strong>Ship to:</strong> ${
          addr
            ? `${addr.Address}, ${addr.City}, ${addr.State} ${addr.Postal_Code}`
            : "-"
        }</div>
<table>
  <thead><tr><th>Item</th><th>Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Line</th></tr></thead>
  <tbody>${rows}</tbody>
  <tfoot>
    <tr><td colspan="3" class="tot" style="text-align:right">Total</td><td class="tot" style="text-align:right">${(
      order.Total || 0
    ).toLocaleString("en-IN")}</td></tr>
  </tfoot>
</table>`;
        const blob = new Blob([html], { type: "text/html" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `truestyle-invoice-${order.id}.html`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 5000);
      }
    </script>
  </body>
</html>
