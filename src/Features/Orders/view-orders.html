<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>TrueStyle - Orders</title>
    <link rel="icon" href="/assets/icon.png"/>
    <link rel="stylesheet" href="/style/index.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      .btn{height:40px;border-radius:10px;padding:0 14px;font-weight:500}
      .btn-ghost{background:#fff;border:1px solid #e2e8f0}
      .btn-ghost:hover{background:#f8fafc}
      .btn-primary{background:#2563eb;color:#fff}
      .btn-primary:hover{filter:brightness(.95)}
      .btn-danger{background:#fff;border:1px solid #fecaca;color:#b91c1c}
      .btn-danger:hover{background:#fff1f2}
      .chip{font-size:12px;padding:.15rem .5rem;border-radius:9999px}
      .chip.bad{background:#fff1f2;color:#b91c1c;border:1px solid #fecaca}
      .field{width:100%;border:1px solid #e2e8f0;border-radius:10px;min-height:40px;padding:8px 10px}
      .field:focus{outline:none;box-shadow:0 0 0 3px rgba(99,102,241,.25)}
      .err{color:#dc2626;font-size:12px}
    </style>
  </head>
  <body class="bg-white text-slate-900">
    <!-- Navbar -->
    <div data-include="/src/Components/navbar.html"></div>

    <main class="max-w-7xl mx-auto px-4 py-6" id="ordersRoot">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-xl font-semibold">Your Orders</h1>
        <a href="/user/index.html" class="px-4 py-2 rounded-lg cursor-pointer ring-1 ring-slate-200 text-md hover:bg-slate-50">Shop more</a>
      </div>
      <div id="ordersList" class="grid gap-4"></div>

      <!-- Empty -->
      <section id="ordersEmpty" class="hidden">
        <div class="rounded-3xl ring-1 ring-slate-200 p-10 text-center bg-white shadow-sm">
          <p class="text-slate-700 font-medium">No orders yet</p>
          <p class="text-slate-500 text-sm mt-1">When you place an order, it’ll show up here.</p>
          <a href="/user/index.html" class="inline-flex mt-4 px-4 py-2 rounded-lg cursor-pointer bg-slate-900 text-white text-md hover:opacity-95">Start shopping</a>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-8">
      <div class="w-full p-6 md:p-10">
        <div class="grid gap-8 md:grid-cols-3">
          <div>
            <h3 class="font-semibold text-xl mb-4">Download the App</h3>
            <div class="flex items-center gap-3">
              <a href="#" class="inline-flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 px-4 py-2 shadow-sm hover:bg-slate-50">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 5a2 2 0 0 1 3-2l12 7a2 2 0 0 1 0 3l-12 7a2 2 0 0 1-3-2z"/></svg>
                <span class="text-sm font-medium">Google Play</span>
              </a>
              <a href="#" class="inline-flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 px-4 py-2 shadow-sm hover:bg-slate-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M16.365 1.43a5.6 5.6 0 0 1-1.382 3.91 4.9 4.9 0 0 1-3.515 1.64 5.45 5.45 0 0 1 1.372-3.97A5.15 5.15 0 0 1 16.365 1.43zM20.5 17.48c-.435 1.01-.658 1.48-1.23 2.39-.8 1.27-1.93 2.85-3.34 2.86-1.25.01-1.58-.84-3.29-.84-1.72 0-2.1.82-3.34.85-1.39.03-2.46-1.37-3.26-2.64-1.78-2.8-3.14-7.92-1.31-11.41.9-1.7 2.5-2.77 4.33-2.8 1.31-.03 2.55.9 3.29.9.73 0 2.26-1.12 3.81-.95.65.03 2.48.26 3.66 1.97-3.22 1.76-2.7 6.41.65 7.67z"/></svg>
                <span class="text-sm font-medium">App Store</span>
              </a>
            </div>
          </div>
          <div>
            <h3 class="font-semibold text-xl mb-4">Shop</h3>
            <ul class="space-y-2 text-sm text-slate-600">
              <li><a href="#" class="hover:text-[var(--color-primary)]">Women’s</a></li>
              <li><a href="#" class="hover:text-[var(--color-primary)]">Men’s</a></li>
              <li><a href="#" class="hover:text-[var(--color-primary)]">Kids</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold text-xl mb-4">About</h3>
            <ul class="space-y-2 text-sm text-slate-600">
              <li><a href="#" class="hover:text-[var(--color-primary)]">About Us</a></li>
              <li><a href="#" class="hover:text-[var(--color-primary)]">Give Feedback</a></li>
              <li><a href="#" class="hover:text-[var(--color-primary)]">Store Locator</a></li>
              <li><a href="mailto:truestyle@example.com" class="hover:text-[var(--color-primary)]">Support: truestyle@example.com | +91 1234567890</a></li>
            </ul>
          </div>
        </div>
        <div class="mt-8 grid gap-4 md:grid-cols-4 text-xs text-slate-500">
          <a href="#policies" class="hover:text-[var(--color-primary)]">Terms &amp; Conditions</a>
          <a href="#policies" class="hover:text-[var(--color-primary)]">Return Policy</a>
          <a href="#policies" class="hover:text-[var(--color-primary)]">Exchange Policy</a>
          <a href="#policies" class="hover:text-[var(--color-primary)]">Privacy Policy</a>
        </div>
        <p class="mt-6 text-sm text-slate-500 text-center">&#169; 2025 TrueStyle. All Rights Reserved.</p>
      </div>
    </footer>

    <!-- Cancel Order Dialog -->
    <dialog id="cancelDlg" class="rounded-2xl p-0 w-[min(560px,95vw)] shadow-2xl">
      <form method="dialog" class="p-0">
        <div class="p-4 border-b bg-slate-50 font-semibold">Cancel Order</div>
        <div class="p-4 grid gap-3 text-sm">
          <p>Select a reason (required) or write your own:</p>
          <div class="grid gap-2">
            <label class="flex items-center gap-2"><input type="radio" name="c_reason" value="Ordered by mistake"> Ordered by mistake</label>
            <label class="flex items-center gap-2"><input type="radio" name="c_reason" value="Found a better price"> Found a better price</label>
            <label class="flex items-center gap-2"><input type="radio" name="c_reason" value="Delivery taking too long"> Delivery taking too long</label>
            <label class="flex items-center gap-2"><input type="radio" name="c_reason" value="Changed my mind"> Changed my mind</label>
          </div>
          <div>
            <textarea id="c_reason_other" class="field" placeholder="Other reason (min 10 characters if used)"></textarea>
            <div id="c_err" class="err hidden mt-1">Please select a reason or enter at least 10 characters.</div>
          </div>
          <div id="c_warning" class="hidden">
            <span class="chip bad">Note</span>
            <span class="text-slate-700"> Orders that are already shipped can’t be cancelled.</span>
          </div>
        </div>
        <div class="p-3 border-t flex justify-end gap-2">
          <button type="button" id="c_cancel" class="btn btn-ghost">Close</button>
          <button type="submit" id="c_ok" class="btn btn-danger">Confirm Cancel</button>
        </div>
      </form>
    </dialog>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden bg-black text-white text-sm px-3 py-2 rounded-lg shadow-lg">Saved</div>

    <!-- Data / Icons -->
    <script src="/Model/appdb.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>

    <script>
      // ---------- Shared helpers ----------
      const $  = (q, root=document)=>root.querySelector(q);
      const $$ = (q, root=document)=>Array.from(root.querySelectorAll(q));
      const fmtINR = n => '₹' + (n||0).toLocaleString('en-IN');
      const toast=(m)=>{const t=$('#toast');t.textContent=m;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),1300);};

      function currentUserId(){
        try{
          if (window.TSAuth?.user?.id) return TSAuth.user.id;
          const u=(AppDB.select('User')||[])[0];
          return u?.id||2001;
        }catch{ return 2001; }
      }
      async function injectPartials(){
        await Promise.all($$('[data-include]').map(async n=>{
          const url=n.getAttribute('data-include');
          const html=await fetch(url, {cache:'no-store'}).then(r=>r.text());
          const tmp=document.createElement('div'); tmp.innerHTML=html;
          n.replaceWith(...tmp.childNodes);
        }));
      }
      function refreshCartBadge(){
        const uid=currentUserId();
        const items=AppDBHelpers.getCart(uid)||[];
        const total=items.reduce((a,i)=>a+(i.Quantity||1),0);
        const b=$("#cartBadge"); if(!b) return;
        if(total>0){ b.textContent=total; b.classList.remove('hidden'); }
        else b.classList.add('hidden');
      }
      function initNavInteractions(){
        lucide.createIcons();
        const btn=$("#profileBtn"), menu=$("#profileMenu");
        btn?.addEventListener("click", ()=>menu?.classList.toggle("hidden"));
        document.addEventListener("click",(e)=>{
          if(!menu?.contains(e.target) && !btn?.contains(e.target)) menu?.classList.add("hidden");
        });
        $("#logOut")?.addEventListener("click", ()=>{
          localStorage.removeItem("ts_is_logged_in");
          localStorage.removeItem("ts_role");
          localStorage.removeItem("ts_user_id");
          location.replace("/index.html");
        });
        $("#navSearchForm")?.addEventListener("submit",(e)=>{
          e.preventDefault();
          const v=$("#navSearch")?.value.trim(); if(!v) return;
          location.href=`/user/index.html?q=${encodeURIComponent(v)}`;
        });
        refreshCartBadge();
      }

      // ---------- Cancel order helpers ----------
      const STATUS = { Placed:1, Confirmed:2, Packed:3, Shipped:4, OutForDelivery:5, Delivered:6, Cancelled:7, Returned:8 };
      const canCancel = (o)=> [STATUS.Placed, STATUS.Confirmed, STATUS.Packed].includes(o.Status);

      const statusChipClass = (id)=>{
        switch(id){
          case 1: return 'bg-slate-50 text-slate-700 ring-1 ring-slate-200';
          case 2: return 'bg-blue-50 text-blue-700 ring-1 ring-blue-200';
          case 3: return 'bg-indigo-50 text-indigo-700 ring-1 ring-indigo-200';
          case 4: return 'bg-sky-50 text-sky-700 ring-1 ring-sky-200';
          case 5: return 'bg-amber-50 text-amber-700 ring-1 ring-amber-200';
          case 6: return 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200';
          case 7: return 'bg-rose-50 text-rose-700 ring-1 ring-rose-200';
          case 8: return 'bg-slate-50 text-slate-700 ring-1 ring-slate-200';
          default: return 'bg-slate-50 text-slate-700 ring-1 ring-slate-200';
        }
      };

      function orderCard(o){
        const itemsHTML = o.items.map(it=>`
          <li class="flex items-center gap-3">
            <img src="${it.product?.Thumbnail}" class="h-20 w-20 rounded-lg object-fit" alt="">
            <div class="flex-1">
              <div class="text-sm line-clamp-1">${it.product?.Name}</div>
              <div class="text-xs text-slate-600">Qty ${it.Quantity} • ${fmtINR(it.product?.price||0)}</div>
            </div>
            <div class="font-semibold">${fmtINR((it.product?.price||0)*(it.Quantity||1))}</div>
          </li>
        `).join('');

        const addr = o.address;
        const addrTxt = addr ? `${addr.Address}, ${addr.City}, ${addr.State} ${addr.Postal_Code}` : '—';

        const eligible = canCancel(o);
        const cancelBtn = eligible
          ? `<button class="btn btn-danger" data-cancel="${o.id}">Cancel order</button>`
          : `<button class="btn btn-danger opacity-60 cursor-not-allowed" title="Order already shipped or completed" disabled>Cancel order</button>`;

        return `
        <article class="group rounded-3xl ring-1 ring-slate-200 p-4 bg-white shadow-sm hover:shadow-lg transition cursor-pointer" data-open="${o.id}">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div class="flex items-center gap-3">
              <span class="text-sm text-slate-500">Order</span>
              <span class="font-semibold">#${o.id}</span>
              <span class="text-xs px-2 py-1 rounded-full ${statusChipClass(o.Status)}">${o.statusText}</span>
            </div>
            <div class="text-sm text-slate-600">${new Date(o.Creation_Date).toLocaleString()}</div>
          </div>

          <ul class="mt-3 grid gap-2">${itemsHTML}</ul>

          <div class="mt-3 grid md:grid-cols-2 gap-3 text-sm">
            <div class="text-slate-700"><span class="text-slate-500">Ship to:</span> ${addrTxt}</div>
            <div class="md:text-right"><span class="text-slate-500">Total:</span> <span class="font-semibold">${fmtINR(o.Total||0)}</span></div>
          </div>

          <div class="mt-3 flex flex-wrap gap-2">
            <button class="btn btn-ghost" data-reorder="${o.id}">Reorder</button>
            <button class="btn btn-primary" data-invoice="${o.id}">Download invoice</button>
            ${cancelBtn}
          </div>
        </article>`;
      }

      // ----- Page render -----
      let ORDERS_CACHE = [];
      function renderOrders(){
        const uid = currentUserId();
        const orders = (AppDBHelpers.userOrders(uid)||[]).map(o=>({
          ...o,
          address: AppDB.get('User_Address', o.Shipping_Address_Id)
        }));
        ORDERS_CACHE = orders;

        const list = $('#ordersList');
        const empty = $('#ordersEmpty');

        if(!orders.length){
          list.innerHTML = '';
          empty.classList.remove('hidden');
          return;
        }

        empty.classList.add('hidden');
        list.innerHTML = orders.map(orderCard).join('');

        // open details
        list.querySelectorAll('[data-open]').forEach(card=>{
          card.addEventListener('click', ()=>{
            const id = Number(card.getAttribute('data-open'));
            location.href = `/src/Features/Orders/view-order.html?id=${id}`;
          });
        });

        // stop propagation on inner buttons
        list.querySelectorAll('[data-reorder]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const id = Number(btn.getAttribute('data-reorder'));
            const o = orders.find(x=>x.id===id);
            if(!o) return;
            o.items.forEach(it=> AppDBHelpers.addToCart(uid, it.Linked_Product_Id, it.Quantity||1));
            refreshCartBadge();
            location.href = '/src/Features/Cart/cart.html';
          });
        });

        list.querySelectorAll('[data-invoice]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const id = Number(btn.getAttribute('data-invoice'));
            const o = orders.find(x=>x.id===id);
            if(o) downloadInvoice(o);
          });
        });

        // Cancel order
        list.querySelectorAll('[data-cancel]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const id = Number(btn.getAttribute('data-cancel'));
            openCancelDialog(id);
          });
        });
      }

      // ----- Cancel dialog logic -----
      let CANCEL_TARGET_ID = null;
      function openCancelDialog(orderId){
        CANCEL_TARGET_ID = orderId;
        const dlg = $('#cancelDlg');
        // reset UI
        dlg.querySelectorAll('input[name="c_reason"]').forEach(r=>r.checked=false);
        $('#c_reason_other').value = '';
        $('#c_err').classList.add('hidden');
        $('#c_warning').classList.add('hidden');

        dlg.showModal();

        $('#c_cancel').onclick = ()=> dlg.close();
        dlg.onclose = ()=>{ CANCEL_TARGET_ID = null; };

        dlg.querySelector('form').onsubmit = (ev)=>{
          ev.preventDefault();
          submitCancel();
        };
      }

      function getCancelReason(){
        const checked = $('#cancelDlg input[name="c_reason"]:checked');
        const other = $('#c_reason_other').value.trim();
        if (checked) return checked.value;
        if (other.length >= 10) return other;
        return '';
      }

      function submitCancel(){
        const dlg = $('#cancelDlg');
        const reason = getCancelReason();
        if (!reason){
          $('#c_err').classList.remove('hidden');
          return;
        }
        // Re-validate eligibility just-in-time
        const o = AppDB.get('Order', CANCEL_TARGET_ID);
        if (!o){
          dlg.close(); toast('Order not found'); return;
        }
        if (! [1,2,3].includes(o.Status)){
          // show a warning in dialog and don’t close
          $('#c_warning').classList.remove('hidden');
          return;
        }

        // Apply cancellation
        const patch = {
          Status: 7,
          statusText: 'Cancelled',
          Modified_Date: new Date().toISOString(),
          Cancellation_Reason: reason
        };
        AppDB.update('Order', o.id, {...o, ...patch});

        dlg.close();
        toast('Order cancelled');
        renderOrders();
      }

      // ----- Invoice (client-side HTML download) -----
      function downloadInvoice(order){
        const addr = AppDB.get('User_Address', order.Shipping_Address_Id);
        const rows = order.items.map(it=>{
          const price = it.product?.price||0;
          return `<tr><td>${it.product?.Name}</td><td style="text-align:center">${it.Quantity}</td><td style="text-align:right">${price.toLocaleString('en-IN')}</td><td style="text-align:right">${(price*(it.Quantity||1)).toLocaleString('en-IN')}</td></tr>`;
        }).join('');
        const html = `
<!doctype html><meta charset="utf-8">
<title>Invoice #${order.id} - TrueStyle</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:#0f172a;padding:24px}
  h1{font-size:18px;margin:0 0 4px}
  .sub{color:#475569}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #e2e8f0;padding:8px;font-size:14px}
  th{background:#f8fafc;text-align:left}
  .tot{font-weight:600}
</style>
<h1>TrueStyle Invoice</h1>
<div class="sub">Order #${order.id} • ${new Date(order.Creation_Date).toLocaleString()}</div>
<hr style="border:none;border-top:1px solid #e2e8f0;margin:12px 0">
<div><strong>Ship to:</strong> ${addr ? `${addr.Address}, ${addr.City}, ${addr.State} ${addr.Postal_Code}` : '-'}</div>
<table>
  <thead><tr><th>Item</th><th>Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Line</th></tr></thead>
  <tbody>${rows}</tbody>
  <tfoot>
    <tr><td colspan="3" class="tot" style="text-align:right">Total</td><td class="tot" style="text-align:right">${(order.Total||0).toLocaleString('en-IN')}</td></tr>
  </tfoot>
</table>`;
        const blob = new Blob([html], {type:'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `truestyle-invoice-${order.id}.html`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
      }

      // ----- Boot -----
      document.addEventListener('DOMContentLoaded', async ()=>{
        await injectPartials();
        initNavInteractions();
        renderOrders();
      });
    </script>
  </body>
</html>