<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TrueStyle - Wishlist</title>
    <link rel="icon" href="/assets/icon.png" />
    <link rel="stylesheet" href="/style/index.css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>
  <body class="bg-white text-slate-900">
    <!-- Navbar -->
    <div data-include="/src/Components/navbar.html"></div>

    <main class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-xl font-semibold">Wishlist</h1>
        <button
          id="clearWish"
          class="hidden py-2 px-4 rounded-lg bg-red-600 text-white text-md hover:bg-red-700 cursor-pointer"
        >
          Clear wishlist
        </button>
      </div>

      <!-- Grid -->
      <div
        id="wishGrid"
        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5"
      ></div>

      <!-- Empty state -->
      <section id="wishEmpty" class="hidden">
        <div
          class="rounded-3xl border border-dashed p-10 text-center bg-slate-50"
        >
          <p class="text-slate-700 font-medium">Your wishlist is empty</p>
          <p class="text-slate-500 text-sm mt-1">
            Save items you love and move them to bag anytime.
          </p>
          <a
            href="/user/index.html"
            class="inline-flex mt-4 h-10 px-5 rounded-2xl bg-slate-900 text-white text-sm hover:opacity-95"
          >
            Continue shopping
          </a>
        </div>
      </section>

      <!-- Recommendations -->
      <section id="recommend" class="mt-10 hidden">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Products you may like</h2>
          <a
            href="/user/index.html"
            class="text-sm text-slate-600 hover:text-slate-900"
            >View all</a
          >
        </div>
        <div id="recGrid" class="grid grid-cols-2 md:grid-cols-4 gap-5"></div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-8">
      <div class="w-full p-6 md:p-10">
        <div class="grid gap-8 md:grid-cols-3">
          <div>
            <h3 class="font-semibold text-xl mb-4">Download the App</h3>
            <div class="flex items-center gap-3">
              <a
                href="#"
                class="inline-flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 px-4 py-2 shadow-sm hover:bg-slate-50"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"
                  />
                </svg>
                <span class="text-sm font-medium">Google Play</span>
              </a>
              <a
                href="#"
                class="inline-flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 px-4 py-2 shadow-sm hover:bg-slate-50"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M16.365 1.43a5.6 5.6 0 01-1.382 3.91 4.9 4.9 0 01-3.515 1.64 5.45 5.45 0 011.372-3.97A5.15 5.15 0 0116.365 1.43zM20.5 17.48c-.435 1.01-.658 1.48-1.23 2.39-.8 1.27-1.93 2.85-3.34 2.86-1.25.01-1.58-.84-3.29-.84-1.72 0-2.1.82-3.34.85-1.39.03-2.46-1.37-3.26-2.64-1.78-2.8-3.14-7.92-1.31-11.41.9-1.7 2.5-2.77 4.33-2.8 1.31-.03 2.55.9 3.29.9.73 0 2.26-1.12 3.81-.95.65.03 2.48.26 3.66 1.97-3.22 1.76-2.7 6.41.65 7.67z"
                  />
                </svg>
                <span class="text-sm font-medium">App Store</span>
              </a>
            </div>
          </div>

          <div>
            <h3 class="font-semibold text-xl mb-4">Shop</h3>
            <ul class="space-y-2 text-sm text-slate-600">
              <li>
                <a href="#" class="hover:text-[var(--color-primary)]"
                  >Women’s</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-[var(--color-primary)]">Men’s</a>
              </li>
              <li>
                <a href="#" class="hover:text-[var(--color-primary)]">Kids</a>
              </li>
            </ul>
          </div>

          <div>
            <h3 class="font-semibold text-xl mb-4">About</h3>
            <ul class="space-y-2 text-sm text-slate-600">
              <li>
                <a
                  href="/index.html#about"
                  class="hover:text-[var(--color-primary)]"
                  >About Us</a
                >
              </li>
              <li>
                <a
                  href="/index.html#contact"
                  class="hover:text-[var(--color-primary)]"
                  >Give Feedback</a
                >
              </li>
              <li>
                <a href="/index.html" class="hover:text-[var(--color-primary)]"
                  >Store Locator</a
                >
              </li>
              <li>
                <a
                  href="mailto:truestyle@example.com"
                  class="hover:text-[var(--color-primary)]"
                  >Support: truestyle@example.com | +91 1234567890</a
                >
              </li>
            </ul>
          </div>
        </div>

        <div class="mt-8 grid gap-4 md:grid-cols-4 text-xs text-slate-500">
          <a
            href="/index.html#policies"
            class="hover:text-[var(--color-primary)] text-md"
            >Terms &amp; Conditions</a
          >
          <a
            href="/index.html#policies"
            class="hover:text-[var(--color-primary)] text-md"
            >Return Policy</a
          >
          <a
            href="/index.html#policies"
            class="hover:text-[var(--color-primary)] text-md"
            >Exchange Policy</a
          >
          <a
            href="/index.html#policies"
            class="hover:text-[var(--color-primary)] text-md"
            >Privacy Policy</a
          >
        </div>

        <p class="mt-6 text-sm text-slate-500 text-center">
          &#169; 2025 TrueStyle. All Rights Reserved.
        </p>
      </div>
    </footer>

    <!-- Confirm Remove Modal -->
    <dialog
      id="confirmModal"
      class="rounded-2xl p-0 w-[min(480px,95vw)] shadow-xl"
    >
      <div class="p-4 border-b bg-slate-50 flex items-center justify-between">
        <h3 class="font-semibold">Remove from wishlist?</h3>
        <button
          id="cmClose"
          class="h-8 w-8 grid place-items-center rounded-lg hover:bg-white"
        >
          <svg viewBox="0 0 24 24" class="h-4 w-4">
            <path
              d="M18 6 6 18M6 6l12 12"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            />
          </svg>
        </button>
      </div>
      <div class="p-4">
        <p class="text-sm text-slate-600">
          This item will be removed from your wishlist.
        </p>
      </div>
      <div class="p-4 border-t flex items-center justify-end gap-2">
        <button
          id="cmCancel"
          class="h-9 px-4 rounded-2xl ring-1 ring-slate-200"
        >
          Cancel
        </button>
        <button
          id="cmConfirm"
          class="h-9 px-4 rounded-2xl bg-red-600 text-white"
        >
          Remove
        </button>
      </div>
    </dialog>

    <!-- Data / Icons -->
    <script src="/Model/appdb.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>

    <script>
      // ---------- Shared helpers ----------
      const $  = (q, root=document)=>root.querySelector(q);
      const $$ = (q, root=document)=>Array.from(root.querySelectorAll(q));
      const fmtINR = (n)=>"₹"+(n||0).toLocaleString("en-IN");

      function currentUserId(){
        try{
          if (window.TSAuth?.user?.id) return TSAuth.user.id;
          const u=(AppDB.select("User")||[])[0];
          return u?.id||2001;
        }catch{ return 2001; }
      }

      async function injectPartials(){
        await Promise.all($$("[data-include]").map(async n=>{
          const url=n.getAttribute("data-include");
          const html=await fetch(url).then(r=>r.text());
          n.outerHTML=html;
        }));
      }

      function refreshCartBadge(){
        const uid=currentUserId();
        const items=AppDBHelpers.getCart(uid)||[];
        const total=items.reduce((a,i)=>a+(i.Quantity||1),0);
        const b=$("#cartBadge"); if(!b) return;
        if(total>0){ b.textContent=total; b.classList.remove("hidden"); }
        else b.classList.add("hidden");
      }

      function initNavInteractions(){
        lucide.createIcons();
        const btn=$("#profileBtn"), menu=$("#profileMenu");
        btn?.addEventListener("click", ()=>menu?.classList.toggle("hidden"));
        document.addEventListener("click",(e)=>{
          if(!menu?.contains(e.target) && !btn?.contains(e.target)) menu?.classList.add("hidden");
        });

        $("#logOut")?.addEventListener("click", ()=>{
          localStorage.removeItem("ts_is_logged_in");
          localStorage.removeItem("ts_role");
          localStorage.removeItem("ts_user_id");
          location.replace("/index.html");
        });

        // Compact category menus
        function closeAllCatMenus(except){
          $$('[data-dd-panel]').forEach(p=>{
            if(p.getAttribute('data-dd-panel')!==except) p.classList.add('hidden');
          });
        }
        $$('[data-dd-btn]').forEach(b=>{
          const key=b.getAttribute('data-dd-btn');
          const panel=document.querySelector(`[data-dd-panel="${key}"]`);
          b.addEventListener('click',(e)=>{
            e.preventDefault();
            const willOpen=panel.classList.contains('hidden');
            closeAllCatMenus(key);
            panel.classList.toggle('hidden',!willOpen);
          });
        });
        document.addEventListener('click',(e)=>{
          if(!e.target.closest('[data-dd-btn]') && !e.target.closest('[data-dd-panel]')) closeAllCatMenus();
        });

        // Navbar search hands off to home search
        $("#navSearchForm")?.addEventListener("submit",(e)=>{
          e.preventDefault();
          const v=$("#navSearch").value.trim();
          if(!v) return;
          const anchor=$("#productsSection");
          if(anchor){
            $("#homeSearch").value=v;
            anchor.scrollIntoView({behavior:"smooth"});
            window.applyHomeFilters?.();
          }else{
            location.href=`/user/index.html?q=${encodeURIComponent(v)}`;
          }
        });

        // Quick filters (legacy)
        $$("[data-cat]").forEach(a=>{
          a.addEventListener("click",(e)=>{
            e.preventDefault();
            const name=a.getAttribute("data-cat");
            localStorage.setItem("ts_user_cat",name);
            const anchor=$("#productsSection");
            if(anchor) anchor.scrollIntoView({behavior:"smooth"});
            window.applyHomeFilters?.();
          });
        });

        refreshCartBadge();
      }
    </script>

    <script>
      // ---------- Wishlist page ----------
      let modalTargetCard = null;
      let modalPid = null;

      document.addEventListener("DOMContentLoaded", async () => {
        await injectPartials();
        initNavInteractions();
        loadAndRenderWishlist();
      });

      function getWishlistIds() {
        const uid = currentUserId();
        if (window.AppDBHelpers?.getWishlist) {
          const rows = AppDBHelpers.getWishlist(uid) || [];
          return rows.map((r) => r.Product_Id).filter(Boolean);
        }
        // Phase-1 fallback demo
        return [5001, 5002];
      }

      function productCard(p) {
        const rating = Number(p.Rating || 0);
        const rc = Math.round(rating * 10) / 10;
        return `
        <article class="group relative rounded-3xl bg-white shadow-sm hover:shadow-lg transition overflow-hidden">
          <a href="/src/Features/Products/view-product.html?id=${
            p.id
          }" class="block">
            <div class="relative">
              <img src="${p.Thumbnail}" alt="${p.Name}"
                   class="w-full object-fit transition duration-300 group-hover:scale-[1.02]">
              ${
                p.Badge
                  ? `<span class="absolute left-3 top-3 text-[11px] px-2 py-1 rounded-full bg-black/80 text-white">${p.Badge}</span>`
                  : ``
              }
              <button data-remove="${p.id}" title="Remove"
                class="absolute right-3 top-3 h-8 w-8 grid place-items-center rounded-full bg-white/90 ring-1 ring-slate-200 hover:bg-white">
                <svg viewBox="0 0 24 24" class="h-4 w-4"><path d="M18 6 6 18M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2"/></svg>
              </button>
            </div>
            <div class="p-3">
              <div class="text-xs text-slate-500">${
                p.Brand || "TrueStyle"
              }</div>
              <h3 class="mt-0.5 text-sm font-medium line-clamp-1">${p.Name}</h3>
              <div class="mt-1 flex items-center justify-between">
                <div class="text-base font-semibold">${fmtINR(p.price)}</div>
                ${
                  rating
                    ? `<div class="text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded-full">${rc} ★</div>`
                    : ``
                }
              </div>
            </div>
          </a>
          <div class="px-3 pb-3">
            <button data-add="${
              p.id
            }" class="py-3 w-full rounded-lg bg-slate-900 text-white text-md hover:opacity-95">Move to Bag</button>
          </div>
        </article>`;
      }

      function productCardSmall(p) {
        return `
        <article class="group relative rounded-3xl bg-white shadow-sm hover:shadow-lg transition overflow-hidden">
          <a href="/src/Features/Products/view-product.html?id=${
            p.id
          }" class="block">
            <img src="${p.Thumbnail}" alt="${
          p.Name
        }" class="w-full object-fit transition duration-300 group-hover:scale-[1.02]">
            <div class="p-3">
              <div class="text-xs text-slate-500">${
                p.Brand || "TrueStyle"
              }</div>
              <h3 class="mt-0.5 text-sm font-medium line-clamp-1">${p.Name}</h3>
              <div class="mt-1 text-base font-semibold">${fmtINR(p.price)}</div>
            </div>
          </a>
          <div class="px-3 pb-3">
            <button data-add="${
              p.id
            }" class="py-3 w-full rounded-lg bg-slate-900 text-white text-md hover:opacity-95">Add to Bag</button>
          </div>
        </article>`;
      }

      function loadAndRenderWishlist() {
        const ids = getWishlistIds();
        const items = ids.map((id) => AppDB.get("Product", id)).filter(Boolean);
        const grid = $("#wishGrid");
        const empty = $("#wishEmpty");
        const clear = $("#clearWish");

        if (!items.length) {
          grid.innerHTML = "";
          empty.classList.remove("hidden");
          clear.classList.add("hidden");
          // Recommendations should still show even if wishlist empty
          renderRecommendations([]);
          return;
        }

        empty.classList.add("hidden");
        clear.classList.remove("hidden");
        grid.innerHTML = items.map(productCard).join("");

        // add-to-cart
        grid.querySelectorAll("[data-add]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = Number(btn.getAttribute("data-add"));
            AppDBHelpers.addToCart(currentUserId(), id, 1);
            refreshCartBadge();
            btn.textContent = "Moved ✓";
            btn.disabled = true;
            setTimeout(() => {
              btn.textContent = "Move to Bag";
              btn.disabled = false;
            }, 1200);
          });
        });

        // remove with confirmation
        grid.querySelectorAll("[data-remove]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            modalTargetCard = btn.closest("article");
            modalPid = Number(btn.getAttribute("data-remove"));
            openConfirmModal();
          });
        });

        // clear all
        clear.onclick = () => {
          if (window.AppDBHelpers?.clearWishlist) {
            AppDBHelpers.clearWishlist(currentUserId());
          }
          grid.innerHTML = "";
          empty.classList.remove("hidden");
          clear.classList.add("hidden");
          renderRecommendations([]); // show general recs
        };

        // recommendations based on current wishlist
        renderRecommendations(items);
      }

      // ------- Confirm modal helpers -------
      function openConfirmModal() {
        const dlg = $("#confirmModal");
        if (!dlg.open) dlg.showModal();
        $("#cmCancel").onclick = closeConfirmModal;
        $("#cmClose").onclick = closeConfirmModal;
        $("#cmConfirm").onclick = confirmRemoval;
        dlg.addEventListener(
          "click",
          (e) => {
            const r = dlg.getBoundingClientRect();
            const clickedOutside =
              e.clientX < r.left ||
              e.clientX > r.right ||
              e.clientY < r.top ||
              e.clientY > r.bottom;
            if (clickedOutside) closeConfirmModal();
          },
          { once: true }
        );
      }
      function closeConfirmModal() {
        $("#confirmModal")?.close();
        modalTargetCard = null;
        modalPid = null;
      }
      function confirmRemoval() {
        const grid = $("#wishGrid");
        const card = modalTargetCard;
        const pid = modalPid;
        if (card) card.remove();

        if (window.AppDBHelpers?.removeFromWishlist && pid) {
          AppDBHelpers.removeFromWishlist(currentUserId(), pid);
        }

        // If grid empty after removal, show empty state
        if (!grid.querySelector("article")) {
          $("#wishEmpty").classList.remove("hidden");
          $("#clearWish").classList.add("hidden");
          renderRecommendations([]); // general recs
        }

        closeConfirmModal();
      }

      // ------- Recommendations -------
      function renderRecommendations(wishItems) {
        const recWrap = $("#recommend");
        const recGrid = $("#recGrid");

        // collect candidate products
        const all = (AppDB.select("Product") || []).filter(
          (p) => !p.Out_of_Stock
        );
        const wishIds = new Set((wishItems || []).map((p) => p.id));

        // try to use the top-level category of the first wishlist item
        let candidates = all.filter((p) => !wishIds.has(p.id));
        if (wishItems && wishItems.length) {
          const first = wishItems[0];
          const firstCat = AppDB.get("Category", first.Categories_Id);
          let topCatId = firstCat?.id;
          if (firstCat?.Parent_Category_Id) {
            topCatId = firstCat.Parent_Category_Id;
          }
          if (topCatId) {
            candidates = candidates.filter((p) => {
              const c = AppDB.get("Category", p.Categories_Id);
              return c?.id === topCatId || c?.Parent_Category_Id === topCatId;
            });
          }
        }

        // sort by popularity (reviews), then price ascending
        candidates.sort(
          (a, b) =>
            (b.Reviews_Count || 0) - (a.Reviews_Count || 0) ||
            (a.price || 0) - (b.price || 0)
        );

        // fallback: if not enough, just take first ones
        const picks = candidates.slice(0, 4);
        if (!picks.length) {
          recWrap.classList.add("hidden");
          recGrid.innerHTML = "";
          return;
        }

        recWrap.classList.remove("hidden");
        recGrid.innerHTML = picks.map(productCardSmall).join("");

        // bind add-to-cart in recs
        recGrid.querySelectorAll("[data-add]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = Number(btn.getAttribute("data-add"));
            AppDBHelpers.addToCart(currentUserId(), id, 1);
            refreshCartBadge();
            btn.textContent = "Added ✓";
            btn.disabled = true;
            setTimeout(() => {
              btn.textContent = "Add to Bag";
              btn.disabled = false;
            }, 1200);
          });
        });
      }
    </script>
  </body>
</html>
