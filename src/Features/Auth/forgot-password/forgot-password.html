<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>True Style - Forgot Password</title>
    <link rel="stylesheet" href="/style/index.css" />
    <script src="https://cdn.tailwindcss.com"></script>
        <link rel="shortcut icon" href="/assets/icon.png" type="image/x-icon">
  </head>
  <body class="min-h-screen flex items-center justify-center w-full bg-[url('../assets/bg/bg-3.jpg')] bg-cover">
    <!-- Back to Home link -->
    <a
      href="/index.html"
      class="absolute top-4 left-4 text-sm font-medium px-4 py-2 transition-pulse bg-blue-600 rounded-lg text-white hover:bg-blue-700 animate-bounce"
    >
      Back to Home
    </a>

    <main class="w-full max-w-4xl">
      <!-- Card -->
      <section class="bg-white rounded-xl shadow-2xl overflow-hidden h-screen md:h-[80vh] lg:h-[70vh] fade-up">
        <div class="grid grid-cols-1 md:grid-cols-2 h-full">
          <!-- Left: Image -->
          <div class="bg-white h-full">
            <img
              src="/assets/bg/bg-11.png"
              alt="Forgot password"
              class="w-full h-full object-cover"
            />
          </div>

          <!-- Right: Form -->
          <div class="p-6 sm:p-8 h-full flex items-center">
            <div class="w-full">
              <header class="text-center mb-2">
                <h1 class="text-xl sm:text-2xl font-semibold animate-bounce text-blue-600">
                  Forgot Password
                </h1>
                <p class="text-md text-gray-700">We’ll help you reset it.</p>
              </header>

              <div class="flex justify-center items-center gap-1 mb-2">
                <span class="text-red-600">*</span>
                <p class="text-sm opacity-50">Indicates mandatory fields</p>
              </div>

              <!-- Success banner (hidden by default) -->
              <div id="successBox" class="hidden mb-3 rounded-lg border border-green-200 bg-green-50 p-3 text-green-800 text-sm">
                If an account exists for <span id="successEmail" class="font-semibold"></span>, we’ve sent reset instructions.
              </div>

              <!-- Error banner (hidden by default) -->
              <div id="errorBox" class="hidden mb-3 rounded-lg border border-red-200 bg-red-50 p-3 text-red-800 text-sm">
                We couldn’t find an account with that email.
              </div>

              <form id="forgotForm" class="space-y-4" novalidate>
                <!-- Email -->
                <div>
                  <label for="email" class="block text-md font-medium tracking-wider">
                    EMAIL <span class="text-red-600">*</span>
                  </label>
                  <input
                    id="email"
                    name="email"
                    type="email"
                    placeholder="enter your registered email"
                    required
                    aria-required="true"
                    autocomplete="email"
                    class="mt-1 w-full rounded-md border border-gray-400 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <p id="emailError" class="mt-1 text-xs text-red-600 hidden">
                    Please enter a valid email.
                  </p>
                </div>

                <!-- Actions -->
                <div class="flex items-center justify-between text-sm">
                  <a href="/src/Features/Auth/login/login.html" class="text-blue-700 hover:underline">Back to Login</a>
                  <a href="/src/Features/Auth/register/register.html" class="text-blue-700 hover:underline">Create an Account</a>
                </div>

                <!-- Submit -->
                <button
                  type="submit"
                  class="w-full rounded-md bg-[var(--color-primary)] text-white py-2 text-sm font-medium focus:ring-2 focus:ring-black/50 cursor-pointer hover:bg-[var(--color-primary-hover)]"
                >
                  Send Reset Link
                </button>
              </form>

              <!-- Small helper text -->
              <p class="mt-3 text-xs text-gray-500 text-center">
                Tip: Check your spam folder if you don’t see the email in a few minutes.
              </p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Validation + submit logic -->
    <script>
      const form = document.getElementById("forgotForm");
      const email = document.getElementById("email");
      const emailError = document.getElementById("emailError");
      const successBox = document.getElementById("successBox");
      const successEmail = document.getElementById("successEmail");
      const errorBox = document.getElementById("errorBox");

      function showOrHide(el, show) {
        el.classList.toggle("hidden", !show);
      }
      function markValidity(input, valid) {
        input.classList.toggle("border-red-500", !valid);
        input.classList.toggle("focus:ring-red-500", !valid);
      }
      function validateEmailField() {
        const ok = email.checkValidity();
        showOrHide(emailError, !ok);
        markValidity(email, ok);
        return ok;
      }

      ["input", "blur"].forEach(evt => {
        email.addEventListener(evt, validateEmailField);
      });

      function clearBanners() {
        showOrHide(successBox, false);
        showOrHide(errorBox, false);
      }

      // Helper: attempt to find user by email if TSAuth provides a way.
      function emailExistsInDB(normalizedEmail) {
        try {
          if (window.TSAuth && typeof TSAuth.getUserByEmail === "function") {
            return !!TSAuth.getUserByEmail(normalizedEmail);
          }
          // Fallback: check app DB shape if exposed (optional)
          if (window.TSDB && Array.isArray(TSDB.Users)) {
            return TSDB.Users.some(u => (u.email || u.Email || "").toLowerCase() === normalizedEmail);
          }
        } catch (_) {}
        // Unknown, treat as not found (or you can return true to avoid enumeration)
        return false;
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        clearBanners();

        const ok = validateEmailField();
        if (!ok) return;

        const value = (email.value || "").trim().toLowerCase();

        // Try a proper reset hook if available; else simulate a token for wiring later
        let resetStarted = false;
        try {
          if (window.TSAuth && typeof TSAuth.startReset === "function") {
            TSAuth.startReset(value); // expected to handle email existence & sending
            resetStarted = true;
          }
        } catch (_) {}

        if (!resetStarted) {
          // Minimal fallback: only show success if account exists; else show error
          const exists = emailExistsInDB(value);
          if (exists) {
            // create a demo token to be consumed by your reset page later
            const token = (Math.random().toString(36).slice(2) + Date.now().toString(36));
            try {
              localStorage.setItem("TS_RESET_EMAIL", value);
              localStorage.setItem("TS_RESET_TOKEN", token);
            } catch (_) {}
            successEmail.textContent = value;
            showOrHide(successBox, true);
            email.value = "";
            return;
          } else {
            showOrHide(errorBox, true);
            return;
          }
        }

        // If TSAuth handled it, always show neutral success (don’t expose whether email exists)
        successEmail.textContent = value;
        showOrHide(successBox, true);
        email.value = "";
      });
    </script>

    <!-- Auth redirect if already logged in -->
    <script src="/Model/appdb.js"></script>
    <script src="/Auth_Controller/auth.js"></script>
    <script>
      (function () {
        try {
          if (window.TSAuth && TSAuth.isLoggedIn && TSAuth.isLoggedIn()) {
            TSAuth.role() === "admin"
              ? location.replace("/admin/index.html")
              : location.replace("/user/index.html");
          }
        } catch (_) {}
      })();
    </script>
  </body>
</html>