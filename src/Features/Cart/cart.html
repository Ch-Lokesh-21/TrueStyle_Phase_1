<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TrueStyle - Cart</title>
  <link rel="icon" href="/assets/icon.png"/>
  <link rel="stylesheet" href="/style/index.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-white text-slate-900">
  <!-- Navbar -->
  <div data-include="/src/Components/navbar.html"></div>

  <main class="max-w-7xl mx-auto px-4 py-6" id="bagRoot">
    <!-- Stepper -->
    <section class="mb-6">
      <ol class="flex items-center gap-6 text-sm">
        <li class="flex items-center gap-2 font-semibold">
          <span class="h-6 w-6 grid place-items-center rounded-full bg-slate-900 text-white">1</span> Bag
        </li>
        <li class="flex items-center gap-2 text-slate-500">
          <span class="h-6 w-6 grid place-items-center rounded-full ring-1 ring-slate-300">2</span> Details
        </li>
        <li class="flex items-center gap-2 text-slate-500">
          <span class="h-6 w-6 grid place-items-center rounded-full ring-1 ring-slate-300">3</span> Payment
        </li>
      </ol>
    </section>

    <section class="grid lg:grid-cols-[1fr_.6fr] gap-8">
      <!-- Items -->
      <div class="space-y-3" id="bagList"></div>

      <!-- Summary -->
      <aside class="rounded-3xl ring-1 ring-slate-200 p-4 shadow-sm h-fit">
        <h3 class="font-semibold mb-3">Order Summary</h3>
        <div class="flex justify-between text-sm py-1"><span>Items</span><span id="sumItems">0</span></div>
        <div class="flex justify-between text-sm py-1"><span>Total MRP</span><span id="sumMrp">₹0</span></div>
        <div class="flex justify-between text-sm py-1"><span>Discount on MRP</span><span id="sumDisc">₹0</span></div>
        <hr class="my-2">
        <div class="flex justify-between font-semibold text-base py-1"><span>Payable</span><span id="sumTotal">₹0</span></div>
        <button id="checkoutBtn" class="mt-3 w-full rounded-lg bg-slate-900 text-white text-md px-4 py-3 hover:opacity-95 cursor-pointer">Proceed to Checkout</button>
        <p class="mt-2 text-xs text-rose-600">Minimum order value ₹999</p>
      </aside>
    </section>

    <!-- Similar products -->
    <section id="recommend" class="mt-10 hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Similar products you may like</h2>
        <a href="/user/index.html" class="text-sm text-slate-600 hover:text-slate-900">View all</a>
      </div>
      <div id="recGrid" class="grid grid-cols-2 md:grid-cols-4 gap-5"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t mt-8">
    <div class="w-full p-6 md:p-10">
      <div class="grid gap-8 md:grid-cols-3">
        <div>
          <h3 class="font-semibold text-xl mb-4">Download the App</h3>
          <div class="flex items-center gap-3">
            <a href="#" class="inline-flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 px-4 py-2 shadow-sm hover:bg-slate-50">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"/></svg>
              <span class="text-sm font-medium">Google Play</span>
            </a>
            <a href="#" class="inline-flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 px-4 py-2 shadow-sm hover:bg-slate-50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M16.365 1.43a5.6 5.6 0 01-1.382 3.91 4.9 4.9 0 01-3.515 1.64 5.45 5.45 0 011.372-3.97A5.15 5.15 0 0116.365 1.43zM20.5 17.48c-.435 1.01-.658 1.48-1.23 2.39-.8 1.27-1.93 2.85-3.34 2.86-1.25.01-1.58-.84-3.29-.84-1.72 0-2.1.82-3.34.85-1.39.03-2.46-1.37-3.26-2.64-1.78-2.8-3.14-7.92-1.31-11.41.9-1.7 2.5-2.77 4.33-2.8 1.31-.03 2.55.9 3.29.9.73 0 2.26-1.12 3.81-.95.65.03 2.48.26 3.66 1.97-3.22 1.76-2.7 6.41.65 7.67z"/></svg>
              <span class="text-sm font-medium">App Store</span>
            </a>
          </div>
        </div>

        <div>
          <h3 class="font-semibold text-xl mb-4">Shop</h3>
          <ul class="space-y-2 text-sm text-slate-600">
            <li><a href="#" class="hover:text-[var(--color-primary)]">Women’s</a></li>
            <li><a href="#" class="hover:text-[var(--color-primary)]">Men’s</a></li>
            <li><a href="#" class="hover:text-[var(--color-primary)]">Kids</a></li>
          </ul>
        </div>

        <div>
          <h3 class="font-semibold text-xl mb-4">About</h3>
          <ul class="space-y-2 text-sm text-slate-600">
            <li><a href="#" class="hover:text-[var(--color-primary)]">About Us</a></li>
            <li><a href="#" class="hover:text-[var(--color-primary)]">Give Feedback</a></li>
            <li><a href="#" class="hover:text-[var(--color-primary)]">Store Locator</a></li>
            <li><a href="mailto:truestyle@example.com" class="hover:text-[var(--color-primary)]">Support: truestyle@example.com | +91 1234567890</a></li>
          </ul>
        </div>
      </div>

      <div class="mt-8 grid gap-4 md:grid-cols-4 text-xs text-slate-500">
        <a href="#policies" class="hover:text-[var(--color-primary)]">Terms &amp; Conditions</a>
        <a href="#policies" class="hover:text-[var(--color-primary)]">Return Policy</a>
        <a href="#policies" class="hover:text-[var(--color-primary)]">Exchange Policy</a>
        <a href="#policies" class="hover:text-[var(--color-primary)]">Privacy Policy</a>
      </div>

      <p class="mt-6 text-sm text-slate-500 text-center">&#169; 2025 TrueStyle. All Rights Reserved.</p>
    </div>
  </footer>

  <!-- Shared helpers -->
  <script src="/Model/appdb.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>
  <script>
    // ---------- Shared helpers ----------
    const $  = (q, root=document)=>root.querySelector(q);
    const $$ = (q, root=document)=>Array.from(root.querySelectorAll(q));
    const fmtINR = n => '₹' + (n||0).toLocaleString('en-IN');

    function currentUserId(){
      try{
        if (window.TSAuth?.user?.id) return TSAuth.user.id;
        const u = (AppDB.select('User')||[])[0];
        return u?.id || 2001;
      }catch{ return 2001; }
    }

    async function injectPartials(){
      await Promise.all($$('[data-include]').map(async n=>{
        const url = n.getAttribute('data-include');
        const html = await fetch(url).then(r=>r.text());
        n.outerHTML = html;
      }));
    }

    function refreshCartBadge(){
      const uid = currentUserId();
      const items = AppDBHelpers.getCart(uid) || [];
      const totalQty = items.reduce((a,i)=>a+(i.Quantity||1),0);
      const b = $('#cartBadge'); if(!b) return;
      if (totalQty>0){ b.textContent = totalQty; b.classList.remove('hidden'); }
      else b.classList.add('hidden');
    }

    function initNavInteractions(){
      lucide.createIcons();
      const btn = $('#profileBtn'), menu = $('#profileMenu');
      btn?.addEventListener('click', ()=> menu?.classList.toggle('hidden'));
      document.addEventListener('click', (e)=>{
        if (!menu?.contains(e.target) && !btn?.contains(e.target)) menu?.classList.add('hidden');
      });

      $('#logOut')?.addEventListener('click', ()=>{
        localStorage.removeItem('ts_is_logged_in');
        localStorage.removeItem('ts_role');
        localStorage.removeItem('ts_user_id');
        location.replace('/index.html');
      });

      // Navbar search → home search
      $('#navSearchForm')?.addEventListener('submit',(e)=>{
        e.preventDefault();
        const v = $('#navSearch').value.trim();
        if(!v) return;
        location.href=`/user/index.html?q=${encodeURIComponent(v)}`;
      });

      refreshCartBadge();
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', initBag);
    async function initBag(){
      await injectPartials();
      initNavInteractions();
      renderBag();
    }

    function qtyPill(ciId, value){
      return `
        <div class="flex items-center rounded-2xl ring-1 ring-slate-200 overflow-hidden">
          <button class="px-3 py-2 text-lg cursor-pointer" data-dec="${ciId}" aria-label="Decrease">−</button>
          <span class="min-w-10 text-center px-3 py-2 text-md">${value}</span>
          <button class="px-3 py-2 text-lg cursor-pointer" data-inc="${ciId}" aria-label="Increase">＋</button>
        </div>`;
    }

    function lineRow(ci, p){
      const line = (p?.price||0) * (ci.Quantity||1);
      return `
      <article class="p-3 rounded-3xl ring-1 ring-slate-200 bg-white shadow-sm flex gap-3 items-center">
        <img src="${p.Thumbnail}" alt="${p.Name}" class="h-50 w-40 rounded-2xl object-fit">
        <div class="flex-1">
          <div class="text-sm text-slate-500">${p.Brand||'TrueStyle'}</div>
          <a href="/src/Features/Products/view-product.html?id=${p.id}" class="font-medium hover:underline">${p.Name}</a>
          <div class="text-sm text-slate-600">Delivery by 4–5 days</div>

          <div class="mt-3 flex flex-wrap items-center gap-3">
            ${qtyPill(ci.id, ci.Quantity||1)}
            <button class="px-3 py-2 text-md rounded-lg ring-1 cursor-pointer ring-slate-200 hover:bg-slate-50" title="Move to wishlist" data-move="${ci.id}">
              Wishlist
            </button>
            <button class="px-3 py-2 text-md rounded-lg cursor-pointer ring-1 ring-slate-200 hover:bg-slate-50" title="Remove" data-del="${ci.id}">
              Remove
            </button>
          </div>
        </div>
        <div class="font-semibold whitespace-nowrap">${fmtINR(line)}</div>
      </article>`;
    }

    function productCardSmall(p){
      return `
      <article class="group relative rounded-3xl bg-white shadow-sm hover:shadow-lg transition overflow-hidden">
        <a href="/src/Features/Products/view-product.html?id=${p.id}" class="block">
          <img src="${p.Thumbnail}" alt="${p.Name}" class="w-full object-fit transition duration-300 group-hover:scale-[1.02]">
          <div class="p-3">
            <div class="text-xs text-slate-500">${p.Brand || "TrueStyle"}</div>
            <h3 class="mt-0.5 text-sm font-medium line-clamp-1">${p.Name}</h3>
            <div class="mt-1 text-base font-semibold">${fmtINR(p.price)}</div>
          </div>
        </a>
        <div class="px-3 pb-3">
          <button data-add="${p.id}" class="w-full rounded-lg bg-slate-900 text-white text-md px-4 py-2 hover:opacity-95">Add to Bag</button>
        </div>
      </article>`;
    }

    function renderBag(){
      const uid = currentUserId();
      const list = AppDBHelpers.getCart(uid) || [];
      const rows = list.map(ci => ({ ci, p: ci.product, line:(ci.product?.price||0)*(ci.Quantity||1) }));
      const bag = $('#bagList');

      if (!rows.length){
        bag.innerHTML = `
          <div class="p-6 rounded-3xl ring-1 ring-slate-200 text-center">
            <p class="font-medium">Your bag is empty</p>
            <p class="text-sm text-slate-600 mt-1">Browse the collection and add your favourites.</p>
            <a href="/user/index.html" class="inline-flex mt-4 rounded-2xl bg-slate-900 text-white text-md px-4 py-2 hover:opacity-95">Continue shopping</a>
          </div>`;
        $('#sumItems').textContent='0';
        $('#sumMrp').textContent='₹0';
        $('#sumDisc').textContent='₹0';
        $('#sumTotal').textContent='₹0';
        $('#checkoutBtn').classList.add('opacity-50','pointer-events-none');
        refreshCartBadge();
        // show general recommendations even if empty
        renderRecommendations([]);
        return;
      }

      bag.innerHTML = rows.map(r => lineRow(r.ci, r.p)).join('');

      const qtyTotal = rows.reduce((a,r)=>a+(r.ci.Quantity||1),0);
      const mrp = rows.reduce((a,r)=>a+r.line,0);
      const disc = 0; // Phase-1: no discount logic
      const total = mrp - disc;

      $('#sumItems').textContent = qtyTotal;
      $('#sumMrp').textContent = fmtINR(mrp);
      $('#sumDisc').textContent = '₹'+disc;
      $('#sumTotal').textContent = fmtINR(total);

      // bindings
      $$('[data-inc]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = Number(b.getAttribute('data-inc'));
          const row = list.find(x=>x.id===id);
          AppDB.update('Cart_Item', id, { Quantity: (row.Quantity||1)+1 });
          renderBag();
        });
      });
      $$('[data-dec]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = Number(b.getAttribute('data-dec'));
          const row = list.find(x=>x.id===id);
          const next = Math.max(1, (row.Quantity||1)-1);
          AppDB.update('Cart_Item', id, { Quantity: next });
          renderBag();
        });
      });
      $$('[data-del]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = Number(b.getAttribute('data-del'));
          AppDB.remove('Cart_Item', id);
          renderBag();
        });
      });
      $$('[data-move]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = Number(b.getAttribute('data-move'));
          const row = list.find(x=>x.id===id);
          // If you add helpers later, persist it; now optimistic.
          if (window.AppDBHelpers?.addToWishlist && row?.product?.id){
            AppDBHelpers.addToWishlist(currentUserId(), row.product.id);
          }
          AppDB.remove('Cart_Item', id);
          renderBag();
        });
      });

      $('#checkoutBtn').onclick = ()=> location.href = '/src/Features/Checkout/checkout.html';
      refreshCartBadge();

      // recommendations based on current cart
      renderRecommendations(rows.map(r=>r.p));
    }

    // ---------- Recommendations ----------
    function renderRecommendations(bagProducts){
      const recWrap = $('#recommend');
      const recGrid = $('#recGrid');

      const all = (AppDB.select('Product')||[]).filter(p=>!p.Out_of_Stock);
      const bagIds = new Set((bagProducts||[]).map(p=>p.id));

      // Choose a top-level category from first cart item if available
      let candidates = all.filter(p=>!bagIds.has(p.id));
      if (bagProducts && bagProducts.length){
        const first = bagProducts[0];
        const firstCat = AppDB.get('Category', first.Categories_Id);
        let topCatId = firstCat?.id;
        if (firstCat?.Parent_Category_Id) topCatId = firstCat.Parent_Category_Id;

        if (topCatId){
          candidates = candidates.filter(p=>{
            const c = AppDB.get('Category', p.Categories_Id);
            return c?.id===topCatId || c?.Parent_Category_Id===topCatId;
          });
        }
      }

      // sort by popularity then price
      candidates.sort((a,b)=> (b.Reviews_Count||0)-(a.Reviews_Count||0) || (a.price||0)-(b.price||0));
      const picks = candidates.slice(0,4);

      if (!picks.length){
        recWrap.classList.add('hidden');
        recGrid.innerHTML = '';
        return;
      }

      recWrap.classList.remove('hidden');
      recGrid.innerHTML = picks.map(productCardSmall).join('');

      // add-to-bag for recs
      recGrid.querySelectorAll('[data-add]').forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          e.preventDefault();
          e.stopPropagation();
          const id = Number(btn.getAttribute('data-add'));
          AppDBHelpers.addToCart(currentUserId(), id, 1);
          refreshCartBadge();
          btn.textContent = 'Added ✓';
          btn.disabled = true;
          setTimeout(()=>{ btn.textContent='Add to Bag'; btn.disabled=false; }, 1200);
          // also re-render bag summary totals (optional)
          renderBag();
        });
      });
    }
  </script>
</body>
</html>